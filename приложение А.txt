&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.Ключ.Пустая() Тогда
		Объект.ДатаПростоя = ТекущаяДата();
		ТекПользователь = ПользователиИнформационнойБазы.ТекущийПользователь();
		Объект.Ответственный = Справочники.Пользователи.НайтиПоНаименованию(ТекПользователь.ПолноеИмя);
		Объект.ВидПростоя = Перечисления.СостоянияСотрудника.ПростойПоВинеРаботника;
		Объект.Начисление = ПланыВидовРасчета.Начисления.НайтиПоНаименованию("Часы за свой счет");
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура НачисленияПриИзмененииНаСервере(ТекСтрНом)
	ТекСтр = Объект.Начисления.Получить(ТекСтрНом);
	ТекСотрудник = ТекСтр.Сотрудник;
	ТекВремяНачала = ТекСтр.НачалоПростоя;
	ТекВремяОкончания = ТекСтр.ОкончаниеПростоя;
	Если НЕ ПустаяСтрока(ТекСотрудник) И НЕ ЗначениеЗаполнено(ТекСтр.Подразделение) Тогда
		 ТекСтр.Подразделение = ПолучитьАкутальноеПодразделение(ТекСотрудник);
	КонецЕсли;
	Если ЗначениеЗаполнено(ТекВремяНачала) И ЗначениеЗаполнено(ТекВремяОкончания) Тогда
		ТекСтр.ЧасыПростоя=(ТекВремяОкончания–ТекВремяНачала)/3600;
	КонецЕсли
КонецПроцедуры

&НаКлиенте
Процедура НачисленияПриИзменении(Элемент)
	ТекСтрНом = Элементы.Начисления.ТекущиеДанные;
	НачисленияПриИзмененииНаСервере(ТекСтрНом.НомерСтроки–1);
КонецПроцедуры

Функция ПолучитьАкутальноеПодразделение(ТекСотрудник)	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	КадроваяИсторияСотрудниковИнтервальный.Подразделение КАК Подразделение
	|ИЗ
	|	РегистрСведений.КадроваяИсторияСотрудниковИнтервальный КАК КадроваяИсторияСотрудниковИнтервальный
	|ГДЕ
	|	КадроваяИсторияСотрудниковИнтервальный.Сотрудник = &Сотрудник
	|
	|УПОРЯДОЧИТЬ ПО
	|	КадроваяИсторияСотрудниковИнтервальный.ДатаНачала УБЫВ";
	
	Запрос.УстановитьПараметр("Сотрудник", ТекСотрудник);
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	ВыборкаДетальныеЗаписи.Следующий();
	
	Возврат ВыборкаДетальныеЗаписи.Подразделение;
		
КонецФункции


&НаКлиенте
Процедура НачисленияСотрудникПриИзменении(Элемент)
	Элемент.Родитель.ТекущиеДанные.Подразделение = "";
КонецПроцедуры
